---
title: "COVID-19 SIR Model"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---
# Setup
Load libraries
```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(reshape2)

library(astsa)
library(forecast)
```
Import data
```{r}
import_data <- function(file) {
	df <- read.csv(file, header = FALSE, skip = 1)
	locations <- as.matrix(df[,1])
	dates <- as.matrix(read.csv(file, header = FALSE, nrows = 1)[1,-1])
	df <- as.data.frame(t(df[,-1]))
	rownames(df) <- dates
	colnames(df) <- locations
	# print(sapply(df, class))
	return(df)
}

cases_intl 		<- import_data("data/International/International_covid_cases_data.csv")
deaths_intl 	<- import_data("data/International/International_covid_deaths_data.csv")
cases_LA 		<- import_data("data/LA/LA_cities_covid_data.csv")
cases_US 		<- import_data("data/US_Counties/US_county_covid_cases_data.csv")
deaths_US 		<- import_data("data/US_Counties/US_county_covid_deaths_data.csv")
```
# Plot Data
```{r}
overall_df <- function(df) {
	return(data.frame(days=seq(0,length(rownames(df))-1), 
					  cases=rowSums(df[,-1])))
}

overall_plot <- function(df, title) {
	ggplot(data=df, aes(x=days, y=cases, group=1)) + 
		geom_line() +
		ggtitle(title)
}

cases_LA_overall <- overall_df(cases_LA)
cases_US_overall <- overall_df(cases_US)
cases_intl_overall <- overall_df(cases_intl)

overall_plot(cases_LA_overall, "Overall LA Cases")
overall_plot(cases_US_overall, "Overall US Cases")
overall_plot(cases_intl_overall, "Overall International Cases")
```
```{r warning=FALSE}
plot_all <- function(df, title, legend = FALSE) {
	rownames(df) <- seq(0,length(rownames(df))-1)
	m <- melt(as.matrix(df))
	colnames(m) <- c("Days", "Location", "Count")
	ggplot(m, aes(x=Days, y=Count, color=Location)) +
		geom_line(show.legend = legend) +
		scale_colour_viridis_d() +
		ggtitle(title)
}

max_counts <- function(df) {
	rownames(df) <- seq(0,length(rownames(df))-1)
	m <- melt(as.matrix(df))
	colnames(m) <- c("Days", "Location", "Count")
	return(m %>% group_by(Location) %>% slice_max(n=1, order_by=Count, with_ties = FALSE) %>% ungroup())
}
```
International Cases
```{r}
plot_all(cases_intl, "International Cases")
cases_intl_max <- max_counts(cases_intl)
cases_intl_max <- cases_intl_max[order(cases_intl_max$Count, decreasing = TRUE),]
cases_intl_max
```

US County Cases
```{r}
plot_all(cases_US, "US County Cases")
cases_US_max <- max_counts(cases_US)
cases_US_max <- cases_US_max[order(cases_US_max$Count, decreasing = TRUE),]
cases_US_max
```
LA Cases
```{r}
plot_all(cases_LA, "LA Cases")
cases_LA_max <- max_counts(cases_LA)
cases_LA_max <- cases_LA_max[order(cases_LA_max$Count, decreasing = TRUE),]
cases_LA_max
```
# Locations with Most COVID-19 Cases and Other Selected Plots
International Cases
```{r}
plot_all(select(cases_intl, cases_intl_max$Location[1:10]), "International Cases Top 10", legend=TRUE)
```

US County Cases
```{r}
plot_all(select(cases_US, cases_US_max$Location[1:10]), "US County Cases Top 10", legend=TRUE)

# locations with nice curves
# plot_all(select(cases_US, `New York City, New York`, `Suffolk, New York`, `Cook, Illinois`), "US County Cases Selected Plots", legend = TRUE)

# Los Angeles
# plot_all(select(cases_US, `Los Angeles, California`), "Los Angeles, California")
```
LA Cases
```{r}
plot_all(select(cases_LA, cases_LA_max$Location[1:10]), "LA Cases Top 10", legend=TRUE)
```

# Analyze as Time Series Data
```{r}
# using Suffolk, New York as our training dataset

timeseries=cases_US$`Suffolk, New York`

plot.ts(timeseries)
plot.ts(diff(timeseries))
acf(diff(timeseries))
```

```{r}
percentage = 0.7
train_series <- timeseries[1:length(timeseries)*percentage]
test_series <- timeseries[-1:-length(timeseries)*percentage]

# parametrize model
AutoArimaModel=auto.arima(train_series)
AutoArimaModel

# train
futurVal <- forecast(AutoArimaModel,h=10, level=c(99.5)) 
futurVal <- forecast(AutoArimaModel,h=50, level=c(80)) #adjust timesteps ahead, and confidence level
plot(futurVal)
checkresiduals(AutoArimaModel)
```

